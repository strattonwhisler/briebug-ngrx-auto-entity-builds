import { Injectable, Injector } from '@angular/core';
import { callService } from './service-invocation';
import { transformArrayFromServer, transformArrayToServer, transformSingleFromServer, transformSingleToServer } from './transformation';
import * as i0 from "@angular/core";
/**
 * Looks up client-provided entity service class using Angular's injector and this package's naming
 * conventions.  Then calls client's service and provides success/failure handling.
 */
export class NgrxAutoEntityService {
    constructor(injector) {
        this.injector = injector;
    }
    load(entityInfo, keys, criteria) {
        return callService('load', entityInfo, this.injector, service => service.load(entityInfo, keys, criteria), entity => ({ info: entityInfo, entity: transformSingleFromServer(entityInfo, criteria)(entity) }));
    }
    loadAll(entityInfo, criteria) {
        return callService('loadAll', entityInfo, this.injector, service => service.loadAll(entityInfo, criteria), entities => ({ info: entityInfo, entity: transformArrayFromServer(entityInfo, criteria)(entities) }));
    }
    loadMany(entityInfo, criteria) {
        return callService('loadMany', entityInfo, this.injector, service => service.loadMany(entityInfo, criteria), entities => ({ info: entityInfo, entity: transformArrayFromServer(entityInfo, criteria)(entities) }));
    }
    loadPage(entityInfo, page, criteria) {
        return callService('loadPage', entityInfo, this.injector, service => service.loadPage(entityInfo, page, criteria), result => ({
            info: entityInfo,
            pageInfo: result.pageInfo,
            entity: transformArrayFromServer(entityInfo, criteria)(result.entities)
        }));
    }
    loadRange(entityInfo, range, criteria) {
        return callService('loadRange', entityInfo, this.injector, service => service.loadRange(entityInfo, range, criteria), result => ({
            info: entityInfo,
            rangeInfo: result.rangeInfo,
            entity: transformArrayFromServer(entityInfo, criteria)(result.entities)
        }));
    }
    create(entityInfo, entity, criteria) {
        const transformed = transformSingleToServer(entityInfo, criteria)(entity);
        return callService('create', entityInfo, this.injector, service => service.create(entityInfo, transformed, criteria, entity), created => ({ info: entityInfo, entity: transformSingleFromServer(entityInfo, criteria)(created) }));
    }
    createMany(entityInfo, entities, criteria) {
        const transformed = transformArrayToServer(entityInfo, criteria)(entities);
        return callService('createMany', entityInfo, this.injector, service => service.createMany(entityInfo, transformed, criteria, entities), created => ({ info: entityInfo, entity: transformArrayFromServer(entityInfo, criteria)(created) }));
    }
    update(entityInfo, entity, criteria) {
        const transformed = transformSingleToServer(entityInfo, criteria)(entity);
        return callService('update', entityInfo, this.injector, service => service.update(entityInfo, transformed, criteria, entity), updated => ({ info: entityInfo, entity: transformSingleFromServer(entityInfo, criteria)(updated) }));
    }
    updateMany(entityInfo, entities, criteria) {
        const transformed = transformArrayToServer(entityInfo, criteria)(entities);
        return callService('updateMany', entityInfo, this.injector, service => service.updateMany(entityInfo, transformed, criteria, entities), updatedEntities => ({
            info: entityInfo,
            entity: transformArrayFromServer(entityInfo, criteria)(updatedEntities)
        }));
    }
    upsert(entityInfo, entity, criteria) {
        const transformed = transformSingleToServer(entityInfo, criteria)(entity);
        return callService('upsert', entityInfo, this.injector, service => service.upsert(entityInfo, transformed, criteria, entity), upserted => ({ info: entityInfo, entity: transformSingleFromServer(entityInfo, criteria)(upserted) }));
    }
    upsertMany(entityInfo, entities, criteria) {
        const transformed = transformArrayToServer(entityInfo, criteria)(entities);
        return callService('upsertMany', entityInfo, this.injector, service => service.upsertMany(entityInfo, transformed, criteria, entities), upsertedEntities => ({
            info: entityInfo,
            entity: transformArrayFromServer(entityInfo, criteria)(upsertedEntities)
        }));
    }
    replace(entityInfo, entity, criteria) {
        const transformed = transformSingleToServer(entityInfo, criteria)(entity);
        return callService('replace', entityInfo, this.injector, service => service.replace(entityInfo, transformed, criteria, entity), replaced => ({ info: entityInfo, entity: transformSingleFromServer(entityInfo, criteria)(replaced) }));
    }
    replaceMany(entityInfo, entities, criteria) {
        const transformed = transformArrayToServer(entityInfo, criteria)(entities);
        return callService('replaceMany', entityInfo, this.injector, service => service.replaceMany(entityInfo, transformed, criteria, entities), replaced => ({ info: entityInfo, entity: transformArrayFromServer(entityInfo, criteria)(replaced) }));
    }
    delete(entityInfo, entity, criteria) {
        const transformed = transformSingleToServer(entityInfo, criteria)(entity);
        return callService('delete', entityInfo, this.injector, service => service.delete(entityInfo, transformed, criteria, entity), deleted => ({ info: entityInfo, entity: transformSingleFromServer(entityInfo, criteria)(deleted) }));
    }
    deleteMany(entityInfo, entities, criteria) {
        const transformed = transformArrayToServer(entityInfo, criteria)(entities);
        return callService('deleteMany', entityInfo, this.injector, service => service.deleteMany(entityInfo, transformed, criteria, entities), deleted => ({ info: entityInfo, entity: transformArrayFromServer(entityInfo, criteria)(deleted) }));
    }
    deleteByKey(entityInfo, key, criteria) {
        return callService('deleteByKey', entityInfo, this.injector, service => service.deleteByKey(entityInfo, key, criteria), deletedKey => ({ info: entityInfo, entityIdentity: deletedKey }));
    }
    deleteManyByKey(entityInfo, keys, criteria) {
        return callService('deleteManyByKeys', entityInfo, this.injector, service => service.deleteManyByKeys(entityInfo, keys, criteria), deletedKeys => ({ info: entityInfo, entityIdentities: deletedKeys }));
    }
    /** @nocollapse */ static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: NgrxAutoEntityService, deps: [{ token: i0.Injector }], target: i0.ɵɵFactoryTarget.Injectable }); }
    /** @nocollapse */ static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: NgrxAutoEntityService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: NgrxAutoEntityService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i0.Injector }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25ncngtYXV0by1lbnRpdHkvc3JjL2xpYi9zZXJ2aWNlL3NlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFPckQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25ELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxzQkFBc0IsRUFBRSx5QkFBeUIsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztBQUd4STs7O0dBR0c7QUFFSCxNQUFNLE9BQU8scUJBQXFCO0lBQ2hDLFlBQW9CLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7SUFBRyxDQUFDO0lBRTFDLElBQUksQ0FBUyxVQUF1QixFQUFFLElBQVMsRUFBRSxRQUFjO1FBQzdELE9BQU8sV0FBVyxDQUNoQixNQUFNLEVBQ04sVUFBVSxFQUNWLElBQUksQ0FBQyxRQUFRLEVBQ2IsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLEVBQ25ELE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLHlCQUF5QixDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQVcsRUFBRSxDQUFDLENBQzVHLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxDQUFTLFVBQXVCLEVBQUUsUUFBYztRQUNyRCxPQUFPLFdBQVcsQ0FDaEIsU0FBUyxFQUNULFVBQVUsRUFDVixJQUFJLENBQUMsUUFBUSxFQUNiLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLEVBQ2hELFFBQVEs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LFVBQVUsRUFBRSxDQUFDLENBQ2pFLENBQUM7SUFDSixDQUFDO0lBRUQsZUFBZSxDQUFTLFVBQXVCLEVBQUUsSUFBc0IsRUFBRSxRQUFjO1FBQ3JGLE9BQU8sV0FBVyxDQUNoQixrQkFBa0IsRUFDbEIsVUFBVSxFQUNWLElBQUksQ0FBQyxRQUFRLEVBQ2IsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsRUFDL0QsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUNyRSxDQUFDO0lBQ0osQ0FBQztpSUFuTVUscUJBQXFCO3FJQUFyQixxQkFBcUI7OzJGQUFyQixxQkFBcUI7a0JBRGpDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBJRW50aXR5SW5mbyB9IGZyb20gJy4uL2FjdGlvbnMvZW50aXR5LWluZm8nO1xuaW1wb3J0IHsgUGFnZSwgUmFuZ2UgfSBmcm9tICcuLi9tb2RlbHMnO1xuaW1wb3J0IHsgRW50aXR5SWRlbnRpdHkgfSBmcm9tICcuLi90eXBlcy9lbnRpdHktaWRlbnRpdHknO1xuaW1wb3J0IHsgSUVudGl0eUlkZW50aXRpZXNSZWYsIElFbnRpdHlJZGVudGl0eVJlZiwgSUVudGl0eVBhZ2VSZWYsIElFbnRpdHlSYW5nZVJlZiwgSUVudGl0eVJlZiB9IGZyb20gJy4vcmVmcyc7XG5pbXBvcnQgeyBjYWxsU2VydmljZSB9IGZyb20gJy4vc2VydmljZS1pbnZvY2F0aW9uJztcbmltcG9ydCB7IHRyYW5zZm9ybUFycmF5RnJvbVNlcnZlciwgdHJhbnNmb3JtQXJyYXlUb1NlcnZlciwgdHJhbnNmb3JtU2luZ2xlRnJvbVNlcnZlciwgdHJhbnNmb3JtU2luZ2xlVG9TZXJ2ZXIgfSBmcm9tICcuL3RyYW5zZm9ybWF0aW9uJztcbmltcG9ydCB7IElFbnRpdHlXaXRoUGFnZUluZm8sIElFbnRpdHlXaXRoUmFuZ2VJbmZvIH0gZnJvbSAnLi93cmFwcGVyLW1vZGVscyc7XG5cbi8qKlxuICogTG9va3MgdXAgY2xpZW50LXByb3ZpZGVkIGVudGl0eSBzZXJ2aWNlIGNsYXNzIHVzaW5nIEFuZ3VsYXIncyBpbmplY3RvciBhbmQgdGhpcyBwYWNrYWdlJ3MgbmFtaW5nXG4gKiBjb252ZW50aW9ucy4gIFRoZW4gY2FsbHMgY2xpZW50J3Mgc2VydmljZSBhbmQgcHJvdmlkZXMgc3VjY2Vzcy9mYWlsdXJlIGhhbmRsaW5nLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmdyeEF1dG9FbnRpdHlTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHt9XG5cbiAgbG9hZDxUTW9kZWw+KGVudGl0eUluZm86IElFbnRpdHlJbmZvLCBrZXlzOiBhbnksIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5UmVmPFRNb2RlbD4+IHtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWwsIElFbnRpdHlSZWY8VE1vZGVsPj4oXG4gICAgICAnbG9hZCcsXG4gICAgICBlbnRpdHlJbmZvLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHNlcnZpY2UgPT4gc2VydmljZS5sb2FkKGVudGl0eUluZm8sIGtleXMsIGNyaXRlcmlhKSxcbiAgICAgIGVudGl0eSA9PiAoeyBpbmZvOiBlbnRpdHlJbmZvLCBlbnRpdHk6IHRyYW5zZm9ybVNpbmdsZUZyb21TZXJ2ZXIoZW50aXR5SW5mbywgY3JpdGVyaWEpKGVudGl0eSkgYXMgVE1vZGVsIH0pXG4gICAgKTtcbiAgfVxuXG4gIGxvYWRBbGw8VE1vZGVsPihlbnRpdHlJbmZvOiBJRW50aXR5SW5mbywgY3JpdGVyaWE/OiBhbnkpOiBPYnNlcnZhYmxlPElFbnRpdHlSZWY8VE1vZGVsW10+PiB7XG4gICAgcmV0dXJuIGNhbGxTZXJ2aWNlPFRNb2RlbCwgVE1vZGVsW10sIElFbnRpdHlSZWY8VE1vZGVsW10+PihcbiAgICAgICdsb2FkQWxsJyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLmxvYWRBbGwoZW50aXR5SW5mbywgY3JpdGVyaWEpLFxuICAgICAgZW50aXRpZXMgPT4gKHsgaW5mbzogZW50aXR5SW5mbywgZW50aXR5OiB0cmFuc2Zvcm1BcnJheUZyb21TZXJ2ZXIoZW50aXR5SW5mbywgY3JpdGVyaWEpKGVudGl0aWVzKSBhcyBUTW9kZWxbXSB9KVxuICAgICk7XG4gIH1cblxuICBsb2FkTWFueTxUTW9kZWw+KGVudGl0eUluZm86IElFbnRpdHlJbmZvLCBjcml0ZXJpYT86IGFueSk6IE9ic2VydmFibGU8SUVudGl0eVJlZjxUTW9kZWxbXT4+IHtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWxbXSwgSUVudGl0eVJlZjxUTW9kZWxbXT4+KFxuICAgICAgJ2xvYWRNYW55JyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLmxvYWRNYW55KGVudGl0eUluZm8sIGNyaXRlcmlhKSxcbiAgICAgIGVudGl0aWVzID0+ICh7IGluZm86IGVudGl0eUluZm8sIGVudGl0eTogdHJhbnNmb3JtQXJyYXlGcm9tU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShlbnRpdGllcykgYXMgVE1vZGVsW10gfSlcbiAgICApO1xuICB9XG5cbiAgbG9hZFBhZ2U8VE1vZGVsPihlbnRpdHlJbmZvOiBJRW50aXR5SW5mbywgcGFnZTogUGFnZSwgY3JpdGVyaWE/OiBhbnkpOiBPYnNlcnZhYmxlPElFbnRpdHlQYWdlUmVmPFRNb2RlbD4+IHtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBJRW50aXR5V2l0aFBhZ2VJbmZvPFRNb2RlbD4sIElFbnRpdHlQYWdlUmVmPFRNb2RlbD4+KFxuICAgICAgJ2xvYWRQYWdlJyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLmxvYWRQYWdlKGVudGl0eUluZm8sIHBhZ2UsIGNyaXRlcmlhKSxcbiAgICAgIHJlc3VsdCA9PiAoe1xuICAgICAgICBpbmZvOiBlbnRpdHlJbmZvLFxuICAgICAgICBwYWdlSW5mbzogcmVzdWx0LnBhZ2VJbmZvLFxuICAgICAgICBlbnRpdHk6IHRyYW5zZm9ybUFycmF5RnJvbVNlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkocmVzdWx0LmVudGl0aWVzKSBhcyBUTW9kZWxbXVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgbG9hZFJhbmdlPFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIHJhbmdlOiBSYW5nZSwgY3JpdGVyaWE/OiBhbnkpOiBPYnNlcnZhYmxlPElFbnRpdHlSYW5nZVJlZjxUTW9kZWw+PiB7XG4gICAgcmV0dXJuIGNhbGxTZXJ2aWNlPFRNb2RlbCwgSUVudGl0eVdpdGhSYW5nZUluZm88VE1vZGVsPiwgSUVudGl0eVJhbmdlUmVmPFRNb2RlbD4+KFxuICAgICAgJ2xvYWRSYW5nZScsXG4gICAgICBlbnRpdHlJbmZvLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHNlcnZpY2UgPT4gc2VydmljZS5sb2FkUmFuZ2UoZW50aXR5SW5mbywgcmFuZ2UsIGNyaXRlcmlhKSxcbiAgICAgIHJlc3VsdCA9PiAoe1xuICAgICAgICBpbmZvOiBlbnRpdHlJbmZvLFxuICAgICAgICByYW5nZUluZm86IHJlc3VsdC5yYW5nZUluZm8sXG4gICAgICAgIGVudGl0eTogdHJhbnNmb3JtQXJyYXlGcm9tU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShyZXN1bHQuZW50aXRpZXMpIGFzIFRNb2RlbFtdXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBjcmVhdGU8VE1vZGVsPihlbnRpdHlJbmZvOiBJRW50aXR5SW5mbywgZW50aXR5OiBUTW9kZWwsIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5UmVmPFRNb2RlbD4+IHtcbiAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHRyYW5zZm9ybVNpbmdsZVRvU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShlbnRpdHkpO1xuICAgIHJldHVybiBjYWxsU2VydmljZTxUTW9kZWwsIFRNb2RlbCwgSUVudGl0eVJlZjxUTW9kZWw+PihcbiAgICAgICdjcmVhdGUnLFxuICAgICAgZW50aXR5SW5mbyxcbiAgICAgIHRoaXMuaW5qZWN0b3IsXG4gICAgICBzZXJ2aWNlID0+IHNlcnZpY2UuY3JlYXRlKGVudGl0eUluZm8sIHRyYW5zZm9ybWVkLCBjcml0ZXJpYSwgZW50aXR5KSxcbiAgICAgIGNyZWF0ZWQgPT4gKHsgaW5mbzogZW50aXR5SW5mbywgZW50aXR5OiB0cmFuc2Zvcm1TaW5nbGVGcm9tU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShjcmVhdGVkKSBhcyBUTW9kZWwgfSlcbiAgICApO1xuICB9XG5cbiAgY3JlYXRlTWFueTxUTW9kZWw+KGVudGl0eUluZm86IElFbnRpdHlJbmZvLCBlbnRpdGllczogVE1vZGVsW10sIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5UmVmPFRNb2RlbFtdPj4ge1xuICAgIGNvbnN0IHRyYW5zZm9ybWVkID0gdHJhbnNmb3JtQXJyYXlUb1NlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoZW50aXRpZXMpO1xuICAgIHJldHVybiBjYWxsU2VydmljZTxUTW9kZWwsIFRNb2RlbFtdLCBJRW50aXR5UmVmPFRNb2RlbFtdPj4oXG4gICAgICAnY3JlYXRlTWFueScsXG4gICAgICBlbnRpdHlJbmZvLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHNlcnZpY2UgPT4gc2VydmljZS5jcmVhdGVNYW55KGVudGl0eUluZm8sIHRyYW5zZm9ybWVkLCBjcml0ZXJpYSwgZW50aXRpZXMpLFxuICAgICAgY3JlYXRlZCA9PiAoeyBpbmZvOiBlbnRpdHlJbmZvLCBlbnRpdHk6IHRyYW5zZm9ybUFycmF5RnJvbVNlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoY3JlYXRlZCkgYXMgVE1vZGVsW10gfSlcbiAgICApO1xuICB9XG5cbiAgdXBkYXRlPFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIGVudGl0eTogVE1vZGVsLCBjcml0ZXJpYT86IGFueSk6IE9ic2VydmFibGU8SUVudGl0eVJlZjxUTW9kZWw+PiB7XG4gICAgY29uc3QgdHJhbnNmb3JtZWQgPSB0cmFuc2Zvcm1TaW5nbGVUb1NlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoZW50aXR5KTtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWwsIElFbnRpdHlSZWY8VE1vZGVsPj4oXG4gICAgICAndXBkYXRlJyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLnVwZGF0ZShlbnRpdHlJbmZvLCB0cmFuc2Zvcm1lZCwgY3JpdGVyaWEsIGVudGl0eSksXG4gICAgICB1cGRhdGVkID0+ICh7IGluZm86IGVudGl0eUluZm8sIGVudGl0eTogdHJhbnNmb3JtU2luZ2xlRnJvbVNlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkodXBkYXRlZCkgYXMgVE1vZGVsIH0pXG4gICAgKTtcbiAgfVxuXG4gIHVwZGF0ZU1hbnk8VE1vZGVsPihlbnRpdHlJbmZvOiBJRW50aXR5SW5mbywgZW50aXRpZXM6IFRNb2RlbFtdLCBjcml0ZXJpYT86IGFueSk6IE9ic2VydmFibGU8SUVudGl0eVJlZjxUTW9kZWxbXT4+IHtcbiAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHRyYW5zZm9ybUFycmF5VG9TZXJ2ZXIoZW50aXR5SW5mbywgY3JpdGVyaWEpKGVudGl0aWVzKTtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWxbXSwgSUVudGl0eVJlZjxUTW9kZWxbXT4+KFxuICAgICAgJ3VwZGF0ZU1hbnknLFxuICAgICAgZW50aXR5SW5mbyxcbiAgICAgIHRoaXMuaW5qZWN0b3IsXG4gICAgICBzZXJ2aWNlID0+IHNlcnZpY2UudXBkYXRlTWFueShlbnRpdHlJbmZvLCB0cmFuc2Zvcm1lZCwgY3JpdGVyaWEsIGVudGl0aWVzKSxcbiAgICAgIHVwZGF0ZWRFbnRpdGllcyA9PiAoe1xuICAgICAgICBpbmZvOiBlbnRpdHlJbmZvLFxuICAgICAgICBlbnRpdHk6IHRyYW5zZm9ybUFycmF5RnJvbVNlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkodXBkYXRlZEVudGl0aWVzKSBhcyBUTW9kZWxbXVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgdXBzZXJ0PFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIGVudGl0eTogVE1vZGVsLCBjcml0ZXJpYT86IGFueSk6IE9ic2VydmFibGU8SUVudGl0eVJlZjxUTW9kZWw+PiB7XG4gICAgY29uc3QgdHJhbnNmb3JtZWQgPSB0cmFuc2Zvcm1TaW5nbGVUb1NlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoZW50aXR5KTtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWwsIElFbnRpdHlSZWY8VE1vZGVsPj4oXG4gICAgICAndXBzZXJ0JyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLnVwc2VydChlbnRpdHlJbmZvLCB0cmFuc2Zvcm1lZCwgY3JpdGVyaWEsIGVudGl0eSksXG4gICAgICB1cHNlcnRlZCA9PiAoeyBpbmZvOiBlbnRpdHlJbmZvLCBlbnRpdHk6IHRyYW5zZm9ybVNpbmdsZUZyb21TZXJ2ZXIoZW50aXR5SW5mbywgY3JpdGVyaWEpKHVwc2VydGVkKSBhcyBUTW9kZWwgfSlcbiAgICApO1xuICB9XG5cbiAgdXBzZXJ0TWFueTxUTW9kZWw+KGVudGl0eUluZm86IElFbnRpdHlJbmZvLCBlbnRpdGllczogVE1vZGVsW10sIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5UmVmPFRNb2RlbFtdPj4ge1xuICAgIGNvbnN0IHRyYW5zZm9ybWVkID0gdHJhbnNmb3JtQXJyYXlUb1NlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoZW50aXRpZXMpO1xuICAgIHJldHVybiBjYWxsU2VydmljZTxUTW9kZWwsIFRNb2RlbFtdLCBJRW50aXR5UmVmPFRNb2RlbFtdPj4oXG4gICAgICAndXBzZXJ0TWFueScsXG4gICAgICBlbnRpdHlJbmZvLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHNlcnZpY2UgPT4gc2VydmljZS51cHNlcnRNYW55KGVudGl0eUluZm8sIHRyYW5zZm9ybWVkLCBjcml0ZXJpYSwgZW50aXRpZXMpLFxuICAgICAgdXBzZXJ0ZWRFbnRpdGllcyA9PiAoe1xuICAgICAgICBpbmZvOiBlbnRpdHlJbmZvLFxuICAgICAgICBlbnRpdHk6IHRyYW5zZm9ybUFycmF5RnJvbVNlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkodXBzZXJ0ZWRFbnRpdGllcykgYXMgVE1vZGVsW11cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHJlcGxhY2U8VE1vZGVsPihlbnRpdHlJbmZvOiBJRW50aXR5SW5mbywgZW50aXR5OiBUTW9kZWwsIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5UmVmPFRNb2RlbD4+IHtcbiAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHRyYW5zZm9ybVNpbmdsZVRvU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShlbnRpdHkpO1xuICAgIHJldHVybiBjYWxsU2VydmljZTxUTW9kZWwsIFRNb2RlbCwgSUVudGl0eVJlZjxUTW9kZWw+PihcbiAgICAgICdyZXBsYWNlJyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLnJlcGxhY2UoZW50aXR5SW5mbywgdHJhbnNmb3JtZWQsIGNyaXRlcmlhLCBlbnRpdHkpLFxuICAgICAgcmVwbGFjZWQgPT4gKHsgaW5mbzogZW50aXR5SW5mbywgZW50aXR5OiB0cmFuc2Zvcm1TaW5nbGVGcm9tU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShyZXBsYWNlZCkgYXMgVE1vZGVsIH0pXG4gICAgKTtcbiAgfVxuXG4gIHJlcGxhY2VNYW55PFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIGVudGl0aWVzOiBUTW9kZWxbXSwgY3JpdGVyaWE/OiBhbnkpOiBPYnNlcnZhYmxlPElFbnRpdHlSZWY8VE1vZGVsW10+PiB7XG4gICAgY29uc3QgdHJhbnNmb3JtZWQgPSB0cmFuc2Zvcm1BcnJheVRvU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShlbnRpdGllcyk7XG4gICAgcmV0dXJuIGNhbGxTZXJ2aWNlPFRNb2RlbCwgVE1vZGVsW10sIElFbnRpdHlSZWY8VE1vZGVsW10+PihcbiAgICAgICdyZXBsYWNlTWFueScsXG4gICAgICBlbnRpdHlJbmZvLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHNlcnZpY2UgPT4gc2VydmljZS5yZXBsYWNlTWFueShlbnRpdHlJbmZvLCB0cmFuc2Zvcm1lZCwgY3JpdGVyaWEsIGVudGl0aWVzKSxcbiAgICAgIHJlcGxhY2VkID0+ICh7IGluZm86IGVudGl0eUluZm8sIGVudGl0eTogdHJhbnNmb3JtQXJyYXlGcm9tU2VydmVyKGVudGl0eUluZm8sIGNyaXRlcmlhKShyZXBsYWNlZCkgYXMgVE1vZGVsW10gfSlcbiAgICApO1xuICB9XG5cbiAgZGVsZXRlPFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIGVudGl0eTogVE1vZGVsLCBjcml0ZXJpYT86IGFueSk6IE9ic2VydmFibGU8SUVudGl0eVJlZjxUTW9kZWw+PiB7XG4gICAgY29uc3QgdHJhbnNmb3JtZWQgPSB0cmFuc2Zvcm1TaW5nbGVUb1NlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoZW50aXR5KTtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWwsIElFbnRpdHlSZWY8VE1vZGVsPj4oXG4gICAgICAnZGVsZXRlJyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLmRlbGV0ZShlbnRpdHlJbmZvLCB0cmFuc2Zvcm1lZCwgY3JpdGVyaWEsIGVudGl0eSksXG4gICAgICBkZWxldGVkID0+ICh7IGluZm86IGVudGl0eUluZm8sIGVudGl0eTogdHJhbnNmb3JtU2luZ2xlRnJvbVNlcnZlcihlbnRpdHlJbmZvLCBjcml0ZXJpYSkoZGVsZXRlZCkgYXMgVE1vZGVsIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZU1hbnk8VE1vZGVsPihlbnRpdHlJbmZvOiBJRW50aXR5SW5mbywgZW50aXRpZXM6IFRNb2RlbFtdLCBjcml0ZXJpYT86IGFueSk6IE9ic2VydmFibGU8SUVudGl0eVJlZjxUTW9kZWxbXT4+IHtcbiAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHRyYW5zZm9ybUFycmF5VG9TZXJ2ZXIoZW50aXR5SW5mbywgY3JpdGVyaWEpKGVudGl0aWVzKTtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBUTW9kZWxbXSwgSUVudGl0eVJlZjxUTW9kZWxbXT4+KFxuICAgICAgJ2RlbGV0ZU1hbnknLFxuICAgICAgZW50aXR5SW5mbyxcbiAgICAgIHRoaXMuaW5qZWN0b3IsXG4gICAgICBzZXJ2aWNlID0+IHNlcnZpY2UuZGVsZXRlTWFueShlbnRpdHlJbmZvLCB0cmFuc2Zvcm1lZCwgY3JpdGVyaWEsIGVudGl0aWVzKSxcbiAgICAgIGRlbGV0ZWQgPT4gKHsgaW5mbzogZW50aXR5SW5mbywgZW50aXR5OiB0cmFuc2Zvcm1BcnJheUZyb21TZXJ2ZXIoZW50aXR5SW5mbywgY3JpdGVyaWEpKGRlbGV0ZWQpIGFzIFRNb2RlbFtdIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZUJ5S2V5PFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIGtleTogRW50aXR5SWRlbnRpdHksIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5SWRlbnRpdHlSZWY+IHtcbiAgICByZXR1cm4gY2FsbFNlcnZpY2U8VE1vZGVsLCBFbnRpdHlJZGVudGl0eSwgSUVudGl0eUlkZW50aXR5UmVmPihcbiAgICAgICdkZWxldGVCeUtleScsXG4gICAgICBlbnRpdHlJbmZvLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHNlcnZpY2UgPT4gc2VydmljZS5kZWxldGVCeUtleShlbnRpdHlJbmZvLCBrZXksIGNyaXRlcmlhKSxcbiAgICAgIGRlbGV0ZWRLZXkgPT4gKHsgaW5mbzogZW50aXR5SW5mbywgZW50aXR5SWRlbnRpdHk6IGRlbGV0ZWRLZXkgfSlcbiAgICApO1xuICB9XG5cbiAgZGVsZXRlTWFueUJ5S2V5PFRNb2RlbD4oZW50aXR5SW5mbzogSUVudGl0eUluZm8sIGtleXM6IEVudGl0eUlkZW50aXR5W10sIGNyaXRlcmlhPzogYW55KTogT2JzZXJ2YWJsZTxJRW50aXR5SWRlbnRpdGllc1JlZj4ge1xuICAgIHJldHVybiBjYWxsU2VydmljZTxUTW9kZWwsIEVudGl0eUlkZW50aXR5W10sIElFbnRpdHlJZGVudGl0aWVzUmVmPihcbiAgICAgICdkZWxldGVNYW55QnlLZXlzJyxcbiAgICAgIGVudGl0eUluZm8sXG4gICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgc2VydmljZSA9PiBzZXJ2aWNlLmRlbGV0ZU1hbnlCeUtleXMoZW50aXR5SW5mbywga2V5cywgY3JpdGVyaWEpLFxuICAgICAgZGVsZXRlZEtleXMgPT4gKHsgaW5mbzogZW50aXR5SW5mbywgZW50aXR5SWRlbnRpdGllczogZGVsZXRlZEtleXMgfSlcbiAgICApO1xuICB9XG59XG4iXX0=