import { Injectable, Injector } from '@angular/core';
import { select } from '@ngrx/store';
import { combineLatest, of } from 'rxjs';
import { filter, map, mergeMap, take } from 'rxjs/operators';
import { Load } from '../actions/load-actions';
import { LoadAll } from '../actions/load-all-actions';
import { LoadMany } from '../actions/load-many-actions';
import { LoadPage } from '../actions/load-page-actions';
import { LoadRange } from '../actions/load-range-actions';
import { addSeconds, entityCurrentPage, entityCurrentRange, entityIds, entityIsLoading, entityLoadedAt, getAppStore, hasEntitiesLoaded, isSubsequentRange, nowAfterExpiry } from './if-necessary-operator-utils';
import * as i0 from "@angular/core";
export class EntityIfNecessaryOperators {
    constructor(injector) {
        this.injector = injector;
    }
    loadIfNecessary() {
        return (source) => source.pipe(getAppStore(this.injector), mergeMap(({ action: { info, keys, maxAge, criteria, correlationId }, store }) => combineLatest([
            store.pipe(select(entityLoadedAt(info)), take(1)),
            store.pipe(select(entityIsLoading(info)), take(1)),
            store.pipe(select(hasEntitiesLoaded(info)), take(1)),
            of(info.defaultMaxAge),
            store.pipe(select(entityIds(info)), take(1))
        ]).pipe(map(([loadedAt, isLoading, hasEntities, defaultMaxAge, ids]) => ({
            loadedAt,
            isLoading,
            hasEntities,
            defaultMaxAge,
            missing: !loadedAt || !hasEntities || (!!ids && ids.indexOf(keys) === -1),
            checkAge: !!defaultMaxAge || !!maxAge
        })), filter(({ isLoading, missing, checkAge, loadedAt, defaultMaxAge }) => !isLoading && (missing || (checkAge ? nowAfterExpiry(addSeconds(new Date(loadedAt), maxAge || defaultMaxAge)) : missing))), map(() => new Load(info.modelType, keys, criteria, correlationId)))));
    }
    loadAllIfNecessary() {
        return (source) => source.pipe(getAppStore(this.injector), mergeMap(({ action: { info, maxAge, criteria, correlationId }, store }) => combineLatest([
            store.pipe(select(entityLoadedAt(info)), take(1)),
            store.pipe(select(entityIsLoading(info)), take(1)),
            store.pipe(select(hasEntitiesLoaded(info)), take(1)),
            of(info.defaultMaxAge)
        ]).pipe(map(([loadedAt, isLoading, hasEntities, defaultMaxAge]) => ({
            loadedAt,
            isLoading,
            hasEntities,
            defaultMaxAge,
            missing: !loadedAt || !hasEntities,
            checkAge: !!defaultMaxAge || !!maxAge
        })), filter(({ isLoading, missing, checkAge, loadedAt, defaultMaxAge }) => !isLoading &&
            (missing || (checkAge ? nowAfterExpiry(addSeconds(new Date(loadedAt), maxAge || defaultMaxAge)) : missing))), map(() => new LoadAll(info.modelType, criteria, correlationId)))));
    }
    loadManyIfNecessary() {
        return (source) => source.pipe(getAppStore(this.injector), mergeMap(({ action: { info, maxAge, criteria, correlationId }, store }) => combineLatest([
            store.pipe(select(entityLoadedAt(info)), take(1)),
            store.pipe(select(entityIsLoading(info)), take(1)),
            store.pipe(select(hasEntitiesLoaded(info)), take(1)),
            of(info.defaultMaxAge)
        ]).pipe(map(([loadedAt, isLoading, hasEntities, defaultMaxAge]) => ({
            loadedAt,
            isLoading,
            hasEntities,
            defaultMaxAge,
            missing: !loadedAt || !hasEntities,
            checkAge: !!defaultMaxAge || !!maxAge
        })), filter(({ isLoading, missing, checkAge, loadedAt, defaultMaxAge }) => !isLoading && (missing || (checkAge ? nowAfterExpiry(addSeconds(new Date(loadedAt), maxAge || defaultMaxAge)) : missing))), map(() => new LoadMany(info.modelType, criteria, correlationId)))));
    }
    loadPageIfNecessary() {
        return (source) => source.pipe(getAppStore(this.injector), mergeMap(({ action: { info, page, maxAge, criteria, correlationId }, store }) => combineLatest([
            store.pipe(select(entityLoadedAt(info)), take(1)),
            store.pipe(select(entityIsLoading(info)), take(1)),
            store.pipe(select(hasEntitiesLoaded(info)), take(1)),
            of(info.defaultMaxAge),
            store.pipe(select(entityCurrentPage(info)), take(1))
        ]).pipe(map(([loadedAt, isLoading, hasEntities, defaultMaxAge, currentPage]) => ({
            loadedAt,
            isLoading,
            hasEntities,
            defaultMaxAge,
            missing: !loadedAt || !hasEntities,
            samePage: page.page === currentPage.page,
            checkAge: !!defaultMaxAge || !!maxAge
        })), filter(({ isLoading, missing, samePage, checkAge, loadedAt, defaultMaxAge }) => !isLoading &&
            (missing || !samePage || (checkAge ? nowAfterExpiry(addSeconds(new Date(loadedAt), maxAge || defaultMaxAge)) : missing))), map(() => new LoadPage(info.modelType, page, criteria, correlationId)))));
    }
    loadRangeIfNecessary() {
        return (source) => source.pipe(getAppStore(this.injector), mergeMap(({ action: { info, range, maxAge, criteria, correlationId }, store }) => combineLatest([
            store.pipe(select(entityLoadedAt(info)), take(1)),
            store.pipe(select(entityIsLoading(info)), take(1)),
            store.pipe(select(hasEntitiesLoaded(info)), take(1)),
            of(info.defaultMaxAge),
            store.pipe(select(entityCurrentRange(info)), take(1))
        ]).pipe(map(([loadedAt, isLoading, hasEntities, defaultMaxAge, currentRange]) => ({
            loadedAt,
            isLoading,
            hasEntities,
            defaultMaxAge,
            missing: !loadedAt || !hasEntities,
            nonFollowingRange: !isSubsequentRange(range, currentRange),
            checkAge: !!defaultMaxAge || !!maxAge
        })), filter(({ isLoading, missing, nonFollowingRange, checkAge, loadedAt, defaultMaxAge }) => !isLoading &&
            (missing ||
                !nonFollowingRange ||
                (checkAge ? nowAfterExpiry(addSeconds(new Date(loadedAt), maxAge || defaultMaxAge)) : missing))), map(() => new LoadRange(info.modelType, range, criteria, correlationId)))));
    }
    /** @nocollapse */ static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: EntityIfNecessaryOperators, deps: [{ token: i0.Injector }], target: i0.ɵɵFactoryTarget.Injectable }); }
    /** @nocollapse */ static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: EntityIfNecessaryOperators }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.2", ngImport: i0, type: EntityIfNecessaryOperators, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i0.Injector }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWYtbmVjZXNzYXJ5LW9wZXJhdG9ycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25ncngtYXV0by1lbnRpdHkvc3JjL2xpYi9lZmZlY3RzL2lmLW5lY2Vzc2FyeS1vcGVyYXRvcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyQyxPQUFPLEVBQUUsYUFBYSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0QsT0FBTyxFQUFFLElBQUksRUFBbUIsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsT0FBTyxFQUFzQixNQUFNLDZCQUE2QixDQUFDO0FBQzFFLE9BQU8sRUFBRSxRQUFRLEVBQXVCLE1BQU0sOEJBQThCLENBQUM7QUFDN0UsT0FBTyxFQUFFLFFBQVEsRUFBdUIsTUFBTSw4QkFBOEIsQ0FBQztBQUM3RSxPQUFPLEVBQUUsU0FBUyxFQUF3QixNQUFNLCtCQUErQixDQUFDO0FBQ2hGLE9BQU8sRUFDTCxVQUFVLEVBQ1YsaUJBQWlCLEVBQ2pCLGtCQUFrQixFQUNsQixTQUFTLEVBQ1QsZUFBZSxFQUNmLGNBQWMsRUFDZCxXQUFXLEVBQ1gsaUJBQWlCLEVBQ2pCLGlCQUFpQixFQUNqQixjQUFjLEVBQ2YsTUFBTSwrQkFBK0IsQ0FBQzs7QUFHdkMsTUFBTSxPQUFPLDBCQUEwQjtJQUNyQyxZQUFvQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO0lBQUcsQ0FBQztJQUUxQyxlQUFlO1FBQ2IsT0FBTyxDQUFDLE1BQTJDLEVBQUUsRUFBRSxDQUNyRCxNQUFNLENBQUMs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U0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FDekUsQ0FDRixDQUNGLENBQUM7SUFDTixDQUFDO2lJQTVKVSwwQkFBMEI7cUlBQTFCLDBCQUEwQjs7MkZBQTFCLDBCQUEwQjtrQkFEdEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBzZWxlY3QgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIG1lcmdlTWFwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgTG9hZCwgTG9hZElmTmVjZXNzYXJ5IH0gZnJvbSAnLi4vYWN0aW9ucy9sb2FkLWFjdGlvbnMnO1xuaW1wb3J0IHsgTG9hZEFsbCwgTG9hZEFsbElmTmVjZXNzYXJ5IH0gZnJvbSAnLi4vYWN0aW9ucy9sb2FkLWFsbC1hY3Rpb25zJztcbmltcG9ydCB7IExvYWRNYW55LCBMb2FkTWFueUlmTmVjZXNzYXJ5IH0gZnJvbSAnLi4vYWN0aW9ucy9sb2FkLW1hbnktYWN0aW9ucyc7XG5pbXBvcnQgeyBMb2FkUGFnZSwgTG9hZFBhZ2VJZk5lY2Vzc2FyeSB9IGZyb20gJy4uL2FjdGlvbnMvbG9hZC1wYWdlLWFjdGlvbnMnO1xuaW1wb3J0IHsgTG9hZFJhbmdlLCBMb2FkUmFuZ2VJZk5lY2Vzc2FyeSB9IGZyb20gJy4uL2FjdGlvbnMvbG9hZC1yYW5nZS1hY3Rpb25zJztcbmltcG9ydCB7XG4gIGFkZFNlY29uZHMsXG4gIGVudGl0eUN1cnJlbnRQYWdlLFxuICBlbnRpdHlDdXJyZW50UmFuZ2UsXG4gIGVudGl0eUlkcyxcbiAgZW50aXR5SXNMb2FkaW5nLFxuICBlbnRpdHlMb2FkZWRBdCxcbiAgZ2V0QXBwU3RvcmUsXG4gIGhhc0VudGl0aWVzTG9hZGVkLFxuICBpc1N1YnNlcXVlbnRSYW5nZSxcbiAgbm93QWZ0ZXJFeHBpcnlcbn0gZnJvbSAnLi9pZi1uZWNlc3Nhcnktb3BlcmF0b3ItdXRpbHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRW50aXR5SWZOZWNlc3NhcnlPcGVyYXRvcnMge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge31cblxuICBsb2FkSWZOZWNlc3Nhcnk8VE1vZGVsPigpIHtcbiAgICByZXR1cm4gKHNvdXJjZTogT2JzZXJ2YWJsZTxMb2FkSWZOZWNlc3Nhcnk8VE1vZGVsPj4pID0+XG4gICAgICBzb3VyY2UucGlwZShcbiAgICAgICAgZ2V0QXBwU3RvcmU8TG9hZElmTmVjZXNzYXJ5PFRNb2RlbD4+KHRoaXMuaW5qZWN0b3IpLFxuICAgICAgICBtZXJnZU1hcCgoeyBhY3Rpb246IHsgaW5mbywga2V5cywgbWF4QWdlLCBjcml0ZXJpYSwgY29ycmVsYXRpb25JZCB9LCBzdG9yZSB9KSA9PlxuICAgICAgICAgIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICAgICAgc3RvcmUucGlwZShzZWxlY3QoZW50aXR5TG9hZGVkQXQoaW5mbykpLCB0YWtlKDEpKSxcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGVudGl0eUlzTG9hZGluZyhpbmZvKSksIHRha2UoMSkpLFxuICAgICAgICAgICAgc3RvcmUucGlwZShzZWxlY3QoaGFzRW50aXRpZXNMb2FkZWQoaW5mbykpLCB0YWtlKDEpKSxcbiAgICAgICAgICAgIG9mKGluZm8uZGVmYXVsdE1heEFnZSksXG4gICAgICAgICAgICBzdG9yZS5waXBlKHNlbGVjdChlbnRpdHlJZHMoaW5mbykpLCB0YWtlKDEpKVxuICAgICAgICAgIF0pLnBpcGUoXG4gICAgICAgICAgICBtYXAoKFtsb2FkZWRBdCwgaXNMb2FkaW5nLCBoYXNFbnRpdGllcywgZGVmYXVsdE1heEFnZSwgaWRzXSkgPT4gKHtcbiAgICAgICAgICAgICAgbG9hZGVkQXQsXG4gICAgICAgICAgICAgIGlzTG9hZGluZyxcbiAgICAgICAgICAgICAgaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIGRlZmF1bHRNYXhBZ2UsXG4gICAgICAgICAgICAgIG1pc3Npbmc6ICFsb2FkZWRBdCB8fCAhaGFzRW50aXRpZXMgfHwgKCEhaWRzICYmIGlkcy5pbmRleE9mKGtleXMpID09PSAtMSksXG4gICAgICAgICAgICAgIGNoZWNrQWdlOiAhIWRlZmF1bHRNYXhBZ2UgfHwgISFtYXhBZ2VcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgICAgKHsgaXNMb2FkaW5nLCBtaXNzaW5nLCBjaGVja0FnZSwgbG9hZGVkQXQsIGRlZmF1bHRNYXhBZ2UgfSkgPT5cbiAgICAgICAgICAgICAgICAhaXNMb2FkaW5nICYmIChtaXNzaW5nIHx8IChjaGVja0FnZSA/IG5vd0FmdGVyRXhwaXJ5KGFkZFNlY29uZHMobmV3IERhdGUobG9hZGVkQXQpLCBtYXhBZ2UgfHwgZGVmYXVsdE1heEFnZSkpIDogbWlzc2luZykpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbWFwKCgpID0+IG5ldyBMb2FkKGluZm8ubW9kZWxUeXBlLCBrZXlzLCBjcml0ZXJpYSwgY29ycmVsYXRpb25JZCkpXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApO1xuICB9XG5cbiAgbG9hZEFsbElmTmVjZXNzYXJ5PFRNb2RlbD4oKSB7XG4gICAgcmV0dXJuIChzb3VyY2U6IE9ic2VydmFibGU8TG9hZEFsbElmTmVjZXNzYXJ5PFRNb2RlbD4+KSA9PlxuICAgICAgc291cmNlLnBpcGUoXG4gICAgICAgIGdldEFwcFN0b3JlPExvYWRBbGxJZk5lY2Vzc2FyeTxUTW9kZWw+Pih0aGlzLmluamVjdG9yKSxcbiAgICAgICAgbWVyZ2VNYXAoKHsgYWN0aW9uOiB7IGluZm8sIG1heEFnZSwgY3JpdGVyaWEsIGNvcnJlbGF0aW9uSWQgfSwgc3RvcmUgfSkgPT5cbiAgICAgICAgICBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGVudGl0eUxvYWRlZEF0KGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBzdG9yZS5waXBlKHNlbGVjdChlbnRpdHlJc0xvYWRpbmcoaW5mbykpLCB0YWtlKDEpKSxcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGhhc0VudGl0aWVzTG9hZGVkKGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBvZihpbmZvLmRlZmF1bHRNYXhBZ2UpXG4gICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgIG1hcCgoW2xvYWRlZEF0LCBpc0xvYWRpbmcsIGhhc0VudGl0aWVzLCBkZWZhdWx0TWF4QWdlXSkgPT4gKHtcbiAgICAgICAgICAgICAgbG9hZGVkQXQsXG4gICAgICAgICAgICAgIGlzTG9hZGluZyxcbiAgICAgICAgICAgICAgaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIGRlZmF1bHRNYXhBZ2UsXG4gICAgICAgICAgICAgIG1pc3Npbmc6ICFsb2FkZWRBdCB8fCAhaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIGNoZWNrQWdlOiAhIWRlZmF1bHRNYXhBZ2UgfHwgISFtYXhBZ2VcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgICAgKHsgaXNMb2FkaW5nLCBtaXNzaW5nLCBjaGVja0FnZSwgbG9hZGVkQXQsIGRlZmF1bHRNYXhBZ2UgfSkgPT5cbiAgICAgICAgICAgICAgICAhaXNMb2FkaW5nICYmXG4gICAgICAgICAgICAgICAgKG1pc3NpbmcgfHwgKGNoZWNrQWdlID8gbm93QWZ0ZXJFeHBpcnkoYWRkU2Vjb25kcyhuZXcgRGF0ZShsb2FkZWRBdCBhcyBudW1iZXIpLCBtYXhBZ2UgfHwgZGVmYXVsdE1heEFnZSkpIDogbWlzc2luZykpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbWFwKCgpID0+IG5ldyBMb2FkQWxsKGluZm8ubW9kZWxUeXBlLCBjcml0ZXJpYSwgY29ycmVsYXRpb25JZCkpXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApO1xuICB9XG5cbiAgbG9hZE1hbnlJZk5lY2Vzc2FyeTxUTW9kZWw+KCkge1xuICAgIHJldHVybiAoc291cmNlOiBPYnNlcnZhYmxlPExvYWRNYW55SWZOZWNlc3Nhcnk8VE1vZGVsPj4pID0+XG4gICAgICBzb3VyY2UucGlwZShcbiAgICAgICAgZ2V0QXBwU3RvcmU8TG9hZE1hbnlJZk5lY2Vzc2FyeTxUTW9kZWw+Pih0aGlzLmluamVjdG9yKSxcbiAgICAgICAgbWVyZ2VNYXAoKHsgYWN0aW9uOiB7IGluZm8sIG1heEFnZSwgY3JpdGVyaWEsIGNvcnJlbGF0aW9uSWQgfSwgc3RvcmUgfSkgPT5cbiAgICAgICAgICBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGVudGl0eUxvYWRlZEF0KGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBzdG9yZS5waXBlKHNlbGVjdChlbnRpdHlJc0xvYWRpbmcoaW5mbykpLCB0YWtlKDEpKSxcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGhhc0VudGl0aWVzTG9hZGVkKGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBvZihpbmZvLmRlZmF1bHRNYXhBZ2UpXG4gICAgICAgICAgXSkucGlwZShcbiAgICAgICAgICAgIG1hcCgoW2xvYWRlZEF0LCBpc0xvYWRpbmcsIGhhc0VudGl0aWVzLCBkZWZhdWx0TWF4QWdlXSkgPT4gKHtcbiAgICAgICAgICAgICAgbG9hZGVkQXQsXG4gICAgICAgICAgICAgIGlzTG9hZGluZyxcbiAgICAgICAgICAgICAgaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIGRlZmF1bHRNYXhBZ2UsXG4gICAgICAgICAgICAgIG1pc3Npbmc6ICFsb2FkZWRBdCB8fCAhaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIGNoZWNrQWdlOiAhIWRlZmF1bHRNYXhBZ2UgfHwgISFtYXhBZ2VcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgICAgKHsgaXNMb2FkaW5nLCBtaXNzaW5nLCBjaGVja0FnZSwgbG9hZGVkQXQsIGRlZmF1bHRNYXhBZ2UgfSkgPT5cbiAgICAgICAgICAgICAgICAhaXNMb2FkaW5nICYmIChtaXNzaW5nIHx8IChjaGVja0FnZSA/IG5vd0FmdGVyRXhwaXJ5KGFkZFNlY29uZHMobmV3IERhdGUobG9hZGVkQXQpLCBtYXhBZ2UgfHwgZGVmYXVsdE1heEFnZSkpIDogbWlzc2luZykpXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbWFwKCgpID0+IG5ldyBMb2FkTWFueShpbmZvLm1vZGVsVHlwZSwgY3JpdGVyaWEsIGNvcnJlbGF0aW9uSWQpKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIGxvYWRQYWdlSWZOZWNlc3Nhcnk8VE1vZGVsPigpIHtcbiAgICByZXR1cm4gKHNvdXJjZTogT2JzZXJ2YWJsZTxMb2FkUGFnZUlmTmVjZXNzYXJ5PFRNb2RlbD4+KSA9PlxuICAgICAgc291cmNlLnBpcGUoXG4gICAgICAgIGdldEFwcFN0b3JlPExvYWRQYWdlSWZOZWNlc3Nhcnk8VE1vZGVsPj4odGhpcy5pbmplY3RvciksXG4gICAgICAgIG1lcmdlTWFwKCh7IGFjdGlvbjogeyBpbmZvLCBwYWdlLCBtYXhBZ2UsIGNyaXRlcmlhLCBjb3JyZWxhdGlvbklkIH0sIHN0b3JlIH0pID0+XG4gICAgICAgICAgY29tYmluZUxhdGVzdChbXG4gICAgICAgICAgICBzdG9yZS5waXBlKHNlbGVjdChlbnRpdHlMb2FkZWRBdChpbmZvKSksIHRha2UoMSkpLFxuICAgICAgICAgICAgc3RvcmUucGlwZShzZWxlY3QoZW50aXR5SXNMb2FkaW5nKGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBzdG9yZS5waXBlKHNlbGVjdChoYXNFbnRpdGllc0xvYWRlZChpbmZvKSksIHRha2UoMSkpLFxuICAgICAgICAgICAgb2YoaW5mby5kZWZhdWx0TWF4QWdlKSxcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGVudGl0eUN1cnJlbnRQYWdlKGluZm8pKSwgdGFrZSgxKSlcbiAgICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgbWFwKChbbG9hZGVkQXQsIGlzTG9hZGluZywgaGFzRW50aXRpZXMsIGRlZmF1bHRNYXhBZ2UsIGN1cnJlbnRQYWdlXSkgPT4gKHtcbiAgICAgICAgICAgICAgbG9hZGVkQXQsXG4gICAgICAgICAgICAgIGlzTG9hZGluZyxcbiAgICAgICAgICAgICAgaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIGRlZmF1bHRNYXhBZ2UsXG4gICAgICAgICAgICAgIG1pc3Npbmc6ICFsb2FkZWRBdCB8fCAhaGFzRW50aXRpZXMsXG4gICAgICAgICAgICAgIHNhbWVQYWdlOiBwYWdlLnBhZ2UgPT09IGN1cnJlbnRQYWdlLnBhZ2UsXG4gICAgICAgICAgICAgIGNoZWNrQWdlOiAhIWRlZmF1bHRNYXhBZ2UgfHwgISFtYXhBZ2VcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICAgIGZpbHRlcihcbiAgICAgICAgICAgICAgKHsgaXNMb2FkaW5nLCBtaXNzaW5nLCBzYW1lUGFnZSwgY2hlY2tBZ2UsIGxvYWRlZEF0LCBkZWZhdWx0TWF4QWdlIH0pID0+XG4gICAgICAgICAgICAgICAgIWlzTG9hZGluZyAmJlxuICAgICAgICAgICAgICAgIChtaXNzaW5nIHx8ICFzYW1lUGFnZSB8fCAoY2hlY2tBZ2UgPyBub3dBZnRlckV4cGlyeShhZGRTZWNvbmRzKG5ldyBEYXRlKGxvYWRlZEF0KSwgbWF4QWdlIHx8IGRlZmF1bHRNYXhBZ2UpKSA6IG1pc3NpbmcpKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG1hcCgoKSA9PiBuZXcgTG9hZFBhZ2UoaW5mby5tb2RlbFR5cGUsIHBhZ2UsIGNyaXRlcmlhLCBjb3JyZWxhdGlvbklkKSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICk7XG4gIH1cblxuICBsb2FkUmFuZ2VJZk5lY2Vzc2FyeTxUTW9kZWw+KCkge1xuICAgIHJldHVybiAoc291cmNlOiBPYnNlcnZhYmxlPExvYWRSYW5nZUlmTmVjZXNzYXJ5PFRNb2RlbD4+KSA9PlxuICAgICAgc291cmNlLnBpcGUoXG4gICAgICAgIGdldEFwcFN0b3JlPExvYWRSYW5nZUlmTmVjZXNzYXJ5PFRNb2RlbD4+KHRoaXMuaW5qZWN0b3IpLFxuICAgICAgICBtZXJnZU1hcCgoeyBhY3Rpb246IHsgaW5mbywgcmFuZ2UsIG1heEFnZSwgY3JpdGVyaWEsIGNvcnJlbGF0aW9uSWQgfSwgc3RvcmUgfSkgPT5cbiAgICAgICAgICBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGVudGl0eUxvYWRlZEF0KGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBzdG9yZS5waXBlKHNlbGVjdChlbnRpdHlJc0xvYWRpbmcoaW5mbykpLCB0YWtlKDEpKSxcbiAgICAgICAgICAgIHN0b3JlLnBpcGUoc2VsZWN0KGhhc0VudGl0aWVzTG9hZGVkKGluZm8pKSwgdGFrZSgxKSksXG4gICAgICAgICAgICBvZihpbmZvLmRlZmF1bHRNYXhBZ2UpLFxuICAgICAgICAgICAgc3RvcmUucGlwZShzZWxlY3QoZW50aXR5Q3VycmVudFJhbmdlKGluZm8pKSwgdGFrZSgxKSlcbiAgICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgbWFwKChbbG9hZGVkQXQsIGlzTG9hZGluZywgaGFzRW50aXRpZXMsIGRlZmF1bHRNYXhBZ2UsIGN1cnJlbnRSYW5nZV0pID0+ICh7XG4gICAgICAgICAgICAgIGxvYWRlZEF0LFxuICAgICAgICAgICAgICBpc0xvYWRpbmcsXG4gICAgICAgICAgICAgIGhhc0VudGl0aWVzLFxuICAgICAgICAgICAgICBkZWZhdWx0TWF4QWdlLFxuICAgICAgICAgICAgICBtaXNzaW5nOiAhbG9hZGVkQXQgfHwgIWhhc0VudGl0aWVzLFxuICAgICAgICAgICAgICBub25Gb2xsb3dpbmdSYW5nZTogIWlzU3Vic2VxdWVudFJhbmdlKHJhbmdlLCBjdXJyZW50UmFuZ2UpLFxuICAgICAgICAgICAgICBjaGVja0FnZTogISFkZWZhdWx0TWF4QWdlIHx8ICEhbWF4QWdlXG4gICAgICAgICAgICB9KSksXG4gICAgICAgICAgICBmaWx0ZXIoXG4gICAgICAgICAgICAgICh7IGlzTG9hZGluZywgbWlzc2luZywgbm9uRm9sbG93aW5nUmFuZ2UsIGNoZWNrQWdlLCBsb2FkZWRBdCwgZGVmYXVsdE1heEFnZSB9KSA9PlxuICAgICAgICAgICAgICAgICFpc0xvYWRpbmcgJiZcbiAgICAgICAgICAgICAgICAobWlzc2luZyB8fFxuICAgICAgICAgICAgICAgICAgIW5vbkZvbGxvd2luZ1JhbmdlIHx8XG4gICAgICAgICAgICAgICAgICAoY2hlY2tBZ2UgPyBub3dBZnRlckV4cGlyeShhZGRTZWNvbmRzKG5ldyBEYXRlKGxvYWRlZEF0KSwgbWF4QWdlIHx8IGRlZmF1bHRNYXhBZ2UpKSA6IG1pc3NpbmcpKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG1hcCgoKSA9PiBuZXcgTG9hZFJhbmdlKGluZm8ubW9kZWxUeXBlLCByYW5nZSwgY3JpdGVyaWEsIGNvcnJlbGF0aW9uSWQpKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxufVxuIl19