import { camelCase } from '../../util/case';
import { iif, isUndefined, map, noop, compose, throwError } from '../../util/func';
import { getKey } from '../decorators/key-util';
import { FEATURE_AFFINITY } from '../util/util-tokens';
export function stateNameFromAction(action) {
    return camelCase(action.info.modelName);
}
export function featureNameFromAction(action) {
    return action.info.modelType[FEATURE_AFFINITY];
}
export function setNewState(featureName, stateName, state, newState) {
    const nextState = featureName
        ? { ...state, [featureName]: { ...state[featureName], [stateName]: newState } }
        : { ...state, [stateName]: newState };
    return nextState;
}
export const safeGetKey = (action, entity) => compose(map(() => getKey(action, entity)), iif(isUndefined, throwError(
// eslint-disable-next-line max-len
`[NGRX-AE] ! Entity key for \'${action.info.modelName}\' could not be found on this entity instance! Make sure your entity is properly decorated with the necessary key metadata. State will NOT be updated due to misconfiguration of your entity.`), key => key))(null);
export const cloneEntities = (original) => (!!original ? { ...original } : {});
export const cloneIds = (ids) => (!!ids ? [...ids] : []);
export const mergeSingle = (currentEntities, entityKey, newEntity) => ((currentEntities[entityKey] = newEntity), currentEntities);
export const mergeMany = (currentEntities, newEntities, action) => newEntities.reduce((entities, entity) => ((entities[safeGetKey(action, entity)] = entity), entities), currentEntities);
export const deleteSingle = (currentEntities, entityKey) => (delete currentEntities[entityKey], currentEntities);
export const deleteMany = (currentEntities, entityKeys) => (entityKeys.forEach(entityKey => delete currentEntities[entityKey]), currentEntities);
export const pushSingle = (currentIds, entityKey) => (currentIds.push(entityKey), currentIds);
export const pushMany = (currentIds, newEntities, action) => (currentIds.push.apply(currentIds, newEntities.map(entity => safeGetKey(action, entity))),
    currentIds);
export const combineUnique = (currentIds, currentEntities, modifiedEntities, action) => {
    const newIds = modifiedEntities.map(entity => safeGetKey(action, entity)).filter(key => !(key in currentEntities));
    currentIds.push.apply(currentIds, newIds);
    return currentIds;
};
export const has = (array, value) => array.indexOf(value) > -1;
export const pushIfMissing = (currentEntities, currentIds, entityKey) => entityKey in currentEntities ? noop() : currentIds.push(entityKey);
export const pushUnique = (currentEntities, currentIds, entityKey) => (pushIfMissing(currentEntities, currentIds, entityKey), currentIds);
export const pushManyUnique = (currentEntities, currentIds, entityKeys) => (entityKeys.forEach(entityKey => pushIfMissing(currentEntities, currentIds, entityKey)), currentIds);
export const warnMissingPageInfo = (action) => console.log(
// eslint-disable-next-line max-len
`[NGRX-AE] Page information for '${action.info.modelName}' was not provided! Page info should be returned from your entity service's loadPage() method. State WILL be updated, however the current page and total entity count information will be incorrect.`);
export const warnMissingRangeInfo = (action) => console.log(
// eslint-disable-next-line max-len
`[NGRX-AE] Range information for '${action.info.modelName}' was not provided! Range info should be returned from your entity service's loadPage() method. State WILL be updated, however the current page and total entity count information will be incorrect.`);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWN0aW9uLnV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmdyeC1hdXRvLWVudGl0eS9zcmMvbGliL3JlZHVjZXIvcmVkdWN0aW9uLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM1QyxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVuRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdkQsTUFBTSxVQUFVLG1CQUFtQixDQUFDLE1BQXFCO0lBQ3ZELE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUVELE1BQU0sVUFBVSxxQkFBcUIsQ0FBQyxNQUFxQjtJQUN6RCxPQUFRLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBaUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzFELENBQUM7QUFFRCxNQUFNLFVBQVUsV0FBVyxDQUFDLFdBQW1CLEVBQUUsU0FBaUIsRUFBRSxLQUFLLEVBQUUsUUFBMkI7SUFDcEcsTUFBTSxTQUFTLEdBQUcsV0FBVztRQUMzQixDQUFDLENBQUMsRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFBRSxRQUFRLEVBQUUsRUFBRTtRQUMvRSxDQUFDLENBQUMsRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDO0lBQ3hDLE9BQU8sU0FBUyxD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SixNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBRyxDQUFDLE1BQXFCLEVBQUUsRUFBRSxDQUM1RCxPQUFPLENBQUMsR0FBRztBQUNULG1DQUFtQztBQUNuQyxvQ0FBb0MsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLHVNQUF1TSxDQUNqUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY2FtZWxDYXNlIH0gZnJvbSAnLi4vLi4vdXRpbC9jYXNlJztcbmltcG9ydCB7IGlpZiwgaXNVbmRlZmluZWQsIG1hcCwgbm9vcCwgY29tcG9zZSwgdGhyb3dFcnJvciB9IGZyb20gJy4uLy4uL3V0aWwvZnVuYyc7XG5pbXBvcnQgeyBJRW50aXR5QWN0aW9uIH0gZnJvbSAnLi4vYWN0aW9ucy9lbnRpdHktYWN0aW9uJztcbmltcG9ydCB7IGdldEtleSB9IGZyb20gJy4uL2RlY29yYXRvcnMva2V5LXV0aWwnO1xuaW1wb3J0IHsgRW50aXR5SWRlbnRpdHkgfSBmcm9tICcuLi90eXBlcy9lbnRpdHktaWRlbnRpdHknO1xuaW1wb3J0IHsgSUVudGl0eVN0YXRlIH0gZnJvbSAnLi4vdXRpbC9lbnRpdHktc3RhdGUnO1xuaW1wb3J0IHsgRkVBVFVSRV9BRkZJTklUWSB9IGZyb20gJy4uL3V0aWwvdXRpbC10b2tlbnMnO1xuXG5leHBvcnQgZnVuY3Rpb24gc3RhdGVOYW1lRnJvbUFjdGlvbihhY3Rpb246IElFbnRpdHlBY3Rpb24pOiBzdHJpbmcge1xuICByZXR1cm4gY2FtZWxDYXNlKGFjdGlvbi5pbmZvLm1vZGVsTmFtZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmZWF0dXJlTmFtZUZyb21BY3Rpb24oYWN0aW9uOiBJRW50aXR5QWN0aW9uKTogc3RyaW5nIHtcbiAgcmV0dXJuIChhY3Rpb24uaW5mby5tb2RlbFR5cGUgYXMgYW55KVtGRUFUVVJFX0FGRklOSVRZXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldE5ld1N0YXRlKGZlYXR1cmVOYW1lOiBzdHJpbmcsIHN0YXRlTmFtZTogc3RyaW5nLCBzdGF0ZSwgbmV3U3RhdGU6IElFbnRpdHlTdGF0ZTxhbnk+KSB7XG4gIGNvbnN0IG5leHRTdGF0ZSA9IGZlYXR1cmVOYW1lXG4gICAgPyB7IC4uLnN0YXRlLCBbZmVhdHVyZU5hbWVdOiB7IC4uLnN0YXRlW2ZlYXR1cmVOYW1lXSwgW3N0YXRlTmFtZV06IG5ld1N0YXRlIH0gfVxuICAgIDogeyAuLi5zdGF0ZSwgW3N0YXRlTmFtZV06IG5ld1N0YXRlIH07XG4gIHJldHVybiBuZXh0U3RhdGU7XG59XG5cbmV4cG9ydCBjb25zdCBzYWZlR2V0S2V5ID0gPFRNb2RlbD4oYWN0aW9uOiBJRW50aXR5QWN0aW9uLCBlbnRpdHk6IFRNb2RlbCk6IEVudGl0eUlkZW50aXR5ID0+XG4gIGNvbXBvc2UoXG4gICAgbWFwKCgpID0+IGdldEtleShhY3Rpb24sIGVudGl0eSkpLFxuICAgIGlpZihcbiAgICAgIGlzVW5kZWZpbmVkLFxuICAgICAgdGhyb3dFcnJvcihcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICAgICAgYFtOR1JYLUFFXSAhIEVudGl0eSBrZXkgZm9yIFxcJyR7YWN0aW9uLmluZm8ubW9kZWxOYW1lfVxcJyBjb3VsZCBub3QgYmUgZm91bmQgb24gdGhpcyBlbnRpdHkgaW5zdGFuY2UhIE1ha2Ugc3VyZSB5b3VyIGVudGl0eSBpcyBwcm9wZXJseSBkZWNvcmF0ZWQgd2l0aCB0aGUgbmVjZXNzYXJ5IGtleSBtZXRhZGF0YS4gU3RhdGUgd2lsbCBOT1QgYmUgdXBkYXRlZCBkdWUgdG8gbWlzY29uZmlndXJhdGlvbiBvZiB5b3VyIGVudGl0eS5gXG4gICAgICApLFxuICAgICAga2V5ID0+IGtleVxuICAgIClcbiAgKShudWxsKTtcblxuZXhwb3J0IGNvbnN0IGNsb25lRW50aXRpZXMgPSAob3JpZ2luYWw6IGFueSB8IG51bGwpID0+ICghIW9yaWdpbmFsID8geyAuLi5vcmlnaW5hbCB9IDoge30pO1xuXG5leHBvcnQgY29uc3QgY2xvbmVJZHMgPSAoaWRzOiBFbnRpdHlJZGVudGl0eVtdIHwgbnVsbCkgPT4gKCEhaWRzID8gWy4uLmlkc10gOiBbXSk7XG5cbmV4cG9ydCBjb25zdCBtZXJnZVNpbmdsZSA9IChjdXJyZW50RW50aXRpZXMsIGVudGl0eUtleSwgbmV3RW50aXR5KSA9PiAoKGN1cnJlbnRFbnRpdGllc1tlbnRpdHlLZXldID0gbmV3RW50aXR5KSwgY3VycmVudEVudGl0aWVzKTtcblxuZXhwb3J0IGNvbnN0IG1lcmdlTWFueSA9IChjdXJyZW50RW50aXRpZXMsIG5ld0VudGl0aWVzLCBhY3Rpb24pID0+XG4gIG5ld0VudGl0aWVzLnJlZHVjZSgoZW50aXRpZXMsIGVudGl0eSkgPT4gKChlbnRpdGllc1tzYWZlR2V0S2V5KGFjdGlvbiwgZW50aXR5KV0gPSBlbnRpdHkpLCBlbnRpdGllcyksIGN1cnJlbnRFbnRpdGllcyk7XG5cbmV4cG9ydCBjb25zdCBkZWxldGVTaW5nbGUgPSAoY3VycmVudEVudGl0aWVzLCBlbnRpdHlLZXkpID0+IChkZWxldGUgY3VycmVudEVudGl0aWVzW2VudGl0eUtleV0sIGN1cnJlbnRFbnRpdGllcyk7XG5cbmV4cG9ydCBjb25zdCBkZWxldGVNYW55ID0gKGN1cnJlbnRFbnRpdGllcywgZW50aXR5S2V5cykgPT4gKFxuICBlbnRpdHlLZXlzLmZvckVhY2goZW50aXR5S2V5ID0+IGRlbGV0ZSBjdXJyZW50RW50aXRpZXNbZW50aXR5S2V5XSksIGN1cnJlbnRFbnRpdGllc1xuKTtcblxuZXhwb3J0IGNvbnN0IHB1c2hTaW5nbGUgPSAoY3VycmVudElkcywgZW50aXR5S2V5KSA9PiAoY3VycmVudElkcy5wdXNoKGVudGl0eUtleSksIGN1cnJlbnRJZHMpO1xuXG5leHBvcnQgY29uc3QgcHVzaE1hbnkgPSAoY3VycmVudElkcywgbmV3RW50aXRpZXMsIGFjdGlvbikgPT4gKFxuICBjdXJyZW50SWRzLnB1c2guYXBwbHkoXG4gICAgY3VycmVudElkcyxcbiAgICBuZXdFbnRpdGllcy5tYXAoZW50aXR5ID0+IHNhZmVHZXRLZXkoYWN0aW9uLCBlbnRpdHkpKVxuICApLFxuICBjdXJyZW50SWRzXG4pO1xuXG5leHBvcnQgY29uc3QgY29tYmluZVVuaXF1ZSA9IChjdXJyZW50SWRzLCBjdXJyZW50RW50aXRpZXMsIG1vZGlmaWVkRW50aXRpZXMsIGFjdGlvbikgPT4ge1xuICBjb25zdCBuZXdJZHMgPSBtb2RpZmllZEVudGl0aWVzLm1hcChlbnRpdHkgPT4gc2FmZUdldEtleShhY3Rpb24sIGVudGl0eSkpLmZpbHRlcihrZXkgPT4gIShrZXkgaW4gY3VycmVudEVudGl0aWVzKSk7XG4gIGN1cnJlbnRJZHMucHVzaC5hcHBseShjdXJyZW50SWRzLCBuZXdJZHMpO1xuICByZXR1cm4gY3VycmVudElkcztcbn07XG5cbmV4cG9ydCBjb25zdCBoYXMgPSAoYXJyYXksIHZhbHVlKSA9PiBhcnJheS5pbmRleE9mKHZhbHVlKSA+IC0xO1xuXG5leHBvcnQgY29uc3QgcHVzaElmTWlzc2luZyA9IChjdXJyZW50RW50aXRpZXMsIGN1cnJlbnRJZHMsIGVudGl0eUtleSkgPT5cbiAgZW50aXR5S2V5IGluIGN1cnJlbnRFbnRpdGllcyA/IG5vb3AoKSA6IGN1cnJlbnRJZHMucHVzaChlbnRpdHlLZXkpO1xuXG5leHBvcnQgY29uc3QgcHVzaFVuaXF1ZSA9IChjdXJyZW50RW50aXRpZXMsIGN1cnJlbnRJZHMsIGVudGl0eUtleSkgPT4gKHB1c2hJZk1pc3NpbmcoY3VycmVudEVudGl0aWVzLCBjdXJyZW50SWRzLCBlbnRpdHlLZXkpLCBjdXJyZW50SWRzKTtcblxuZXhwb3J0IGNvbnN0IHB1c2hNYW55VW5pcXVlID0gKGN1cnJlbnRFbnRpdGllcywgY3VycmVudElkcywgZW50aXR5S2V5cykgPT4gKFxuICBlbnRpdHlLZXlzLmZvckVhY2goZW50aXR5S2V5ID0+IHB1c2hJZk1pc3NpbmcoY3VycmVudEVudGl0aWVzLCBjdXJyZW50SWRzLCBlbnRpdHlLZXkpKSwgY3VycmVudElkc1xuKTtcblxuZXhwb3J0IGNvbnN0IHdhcm5NaXNzaW5nUGFnZUluZm8gPSAoYWN0aW9uOiBJRW50aXR5QWN0aW9uKSA9PlxuICBjb25zb2xlLmxvZyhcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgIGBbTkdSWC1BRV0gUGFnZSBpbmZvcm1hdGlvbiBmb3IgJyR7YWN0aW9uLmluZm8ubW9kZWxOYW1lfScgd2FzIG5vdCBwcm92aWRlZCEgUGFnZSBpbmZvIHNob3VsZCBiZSByZXR1cm5lZCBmcm9tIHlvdXIgZW50aXR5IHNlcnZpY2UncyBsb2FkUGFnZSgpIG1ldGhvZC4gU3RhdGUgV0lMTCBiZSB1cGRhdGVkLCBob3dldmVyIHRoZSBjdXJyZW50IHBhZ2UgYW5kIHRvdGFsIGVudGl0eSBjb3VudCBpbmZvcm1hdGlvbiB3aWxsIGJlIGluY29ycmVjdC5gXG4gICk7XG5cbmV4cG9ydCBjb25zdCB3YXJuTWlzc2luZ1JhbmdlSW5mbyA9IChhY3Rpb246IElFbnRpdHlBY3Rpb24pID0+XG4gIGNvbnNvbGUubG9nKFxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXG4gICAgYFtOR1JYLUFFXSBSYW5nZSBpbmZvcm1hdGlvbiBmb3IgJyR7YWN0aW9uLmluZm8ubW9kZWxOYW1lfScgd2FzIG5vdCBwcm92aWRlZCEgUmFuZ2UgaW5mbyBzaG91bGQgYmUgcmV0dXJuZWQgZnJvbSB5b3VyIGVudGl0eSBzZXJ2aWNlJ3MgbG9hZFBhZ2UoKSBtZXRob2QuIFN0YXRlIFdJTEwgYmUgdXBkYXRlZCwgaG93ZXZlciB0aGUgY3VycmVudCBwYWdlIGFuZCB0b3RhbCBlbnRpdHkgY291bnQgaW5mb3JtYXRpb24gd2lsbCBiZSBpbmNvcnJlY3QuYFxuICApO1xuIl19